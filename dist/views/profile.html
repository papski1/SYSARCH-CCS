<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-4/5 max-w-3xl">
        <h2 class="text-3xl font-bold text-center mb-6">Profile</h2>

        <div class="flex flex-col items-center">
            <img id="profileImage" src="/uploads/default.png" class="w-32 h-32 rounded-full border mb-4" alt="Profile Picture">
            
            <form id="uploadForm" enctype="multipart/form-data" class="w-full text-center">
                <input type="file" id="imageUpload" class="block w-full text-sm text-gray-600 mb-4">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                    Upload
                </button>
            </form>
        </div>

        <div id="userInfo" class="mt-6 text-center text-lg"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            // ✅ Extract user ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("id");

            if (!userId) {
                document.getElementById("userInfo").innerHTML = "<p class='text-red-500'>No user ID found!</p>";
                return;
            }

            // ✅ Fetch user profile
            const response = await fetch(`/get-profile?id=${userId}`);
            const user = await response.json();

            if (user.error) {
                document.getElementById("userInfo").innerHTML = `<p class='text-red-500'>${user.error}</p>`;
            } else {
                document.getElementById("profileImage").src = user.profileImage || "/uploads/default.png";

                // ✅ Check if the course is related to computers
                const computerCourses = [
                    "BS Computer Science",
                    "BS Information Technology",
                    "BS Information Systems",
                    "BS Software Engineering",
                    "BS Computer Engineering"
                ];
                const remainingSessions = computerCourses.includes(user.course) ? 15 : 10;

                document.getElementById("userInfo").innerHTML = `
                    <p><strong>ID:</strong> ${user.idNumber}</p>
                    <p><strong>Name:</strong> ${user.firstName} ${user.middleName} ${user.lastName}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Year:</strong> ${user.year}</p>
                    <p><strong>Course:</strong> ${user.course}</p>
                    <p><strong>Remaining Sessions:</strong> ${remainingSessions}</p>
                `;
            }
        });

        // ✅ Profile Image Upload
        document.getElementById("uploadForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append("profileImage", document.getElementById("imageUpload").files[0]);

            const response = await fetch("/upload-profile", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                document.getElementById("profileImage").src = result.imagePath;
            }
        });
    </script>    
</body>
</html>
