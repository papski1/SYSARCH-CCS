<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-md p-4 fixed h-full">
            <h3 class="text-xl font-bold mb-4">Dashboard</h3>
            <ul class="space-y-2">
                <li><a href="#dashboard" class="block py-2 px-4 rounded hover:bg-gray-200">Dashboard</a></li>
                <li><a href="#profile" class="block py-2 px-4 rounded hover:bg-gray-200">Profile</a></li>
                <li><a href="#announcements" class="block py-2 px-4 rounded hover:bg-gray-200">Announcements</a></li>
                <li><a href="#lab-rules" class="block py-2 px-4 rounded hover:bg-gray-200">Lab Rules</a></li>
                <li><a href="#reserve-session" class="block py-2 px-4 rounded hover:bg-gray-200">Reserve Session</a></li>
                <li><a href="#" onclick="logout()" class="block py-2 px-4 rounded hover:bg-red-200 text-red-600">Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 space-y-6 ml-64">
            <header>
                <h1 class="text-2xl font-bold">Student Dashboard</h1>
            </header>

             <!-- Profile Section -->
             <section id="profile" class="hidden">
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex items-center space-x-4">
                        <img id="profilePic" src="default-profile.png" alt="Profile Picture" class="w-24 h-24 rounded-full border">
                        <input type="file" id="uploadProfilePic" class="hidden" accept="image/*">
                        <button onclick="document.getElementById('uploadProfilePic').click();" class="bg-blue-500 text-white py-2 px-4 rounded">Upload Photo</button>
                    </div>
            
                    <div class="mt-4">
                        <label>ID Number:</label>
                        <input type="text" id="idNumber" class="w-full border p-2 rounded">
            
                        <label>First Name:</label>
                        <input type="text" id="firstname" class="w-full border p-2 rounded">
            
                        <label>Middle Name:</label>
                        <input type="text" id="middlename" class="w-full border p-2 rounded">
            
                        <label>Last Name:</label>
                        <input type="text" id="lastname" class="w-full border p-2 rounded">
            
                        <label>Email:</label>
                        <input type="email" id="email" class="w-full border p-2 rounded">
            
                        <label>Year:</label>
                        <input type="text" id="year" class="w-full border p-2 rounded">
            
                        <label>Course:</label>
                        <input type="text" id="course" class="w-full border p-2 rounded">

                    <!-- Change Password Modal (Hidden by default) -->
                    <div id="changePasswordModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
                        <div class="bg-white p-6 rounded shadow-lg w-96">
                            <h2 class="text-xl font-semibold mb-4">Change Password</h2>
                            <label>Current Password:</label>
                            <input type="password" id="currentPassword" class="w-full border p-2 rounded mb-2">

                            <label>New Password:</label>
                            <input type="password" id="newPassword" class="w-full border p-2 rounded mb-2">

                            <label>Confirm New Password:</label>
                            <input type="password" id="confirmNewPassword" class="w-full border p-2 rounded mb-2">

                            <div class="flex justify-end mt-4">
                                <button onclick="changePassword()" class="bg-green-500 text-white py-2 px-4 rounded">Update</button>
                                <button onclick="closeChangePasswordModal()" class="bg-red-500 text-white py-2 px-4 rounded ml-2">Cancel</button>
                            </div>
                        </div>
                    </div>

                        <p class="mt-4"><strong>Remaining Sessions:</strong> <span id="remainingSessions">10</span></p>
                    </div>
            
                    <button onclick="saveProfile()" class="bg-green-500 text-white py-2 px-4 rounded mt-4">Save Changes</button>
                    <button onclick="openChangePasswordModal()" class="bg-red-500 text-white py-2 px-4 rounded mt-4">
                        Change Password
                    </button>
                </div>
            </section>

            <!-- Announcements Section (Hidden by default) -->
            <section id="announcements" class="hidden">
                <div class="bg-white p-4 rounded shadow">
                    <p class="text-gray-600">No announcements at this time.</p>
                </div>
            </section>

            <!-- Lab Rules Section (Hidden by default) -->
            <section id="lab-rules" class="hidden">
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex items-center justify-center relative">
                        <!-- Left Image -->
                        <img src="dist/css/images.png" alt="Left Logo" class="w-28 h-28 absolute left-0">
            
                        <!-- Title Section -->
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-gray-800">University of Cebu</h2>
                            <h3 class="text-lg font-semibold text-gray-700">COLLEGE OF INFORMATION & COMPUTER STUDIES</h3>
                            <h4 class="text-md font-semibold text-gray-600">LABORATORY RULES AND REGULATIONS</h4>
                        </div>
            
                        <!-- Right Image -->
                        <img src="dist/css/image.png" alt="Right Logo" class="w-28 h-28 absolute right-0">
                    </div>
                    <p class="mt-4 text-gray-700">To avoid embarrassment and maintain camaraderie with your friends and superiors at our laboratories, please observe the following:</p>
            
                    <ul class="list-decimal list-inside mt-4 text-gray-700 space-y-2">
                        <li>Maintain silence, proper decorum, and discipline inside the laboratory. Mobile phones, walkmans, and other personal pieces of equipment must be switched off.</li>
                        <li>Games are not allowed inside the lab. This includes computer-related games, card games, and other games that may disturb the operation of the lab.</li>
                        <li>Surfing the Internet is allowed only with the permission of the instructor. Downloading and installing of software are strictly prohibited.</li>
                        <li>Getting access to other websites not related to the course (especially pornographic and illicit sites) is strictly prohibited.</li>
                        <li>Deleting computer files and changing the set-up of the computer is a major offense.</li>
                        <li>Observe computer time usage carefully. A fifteen-minute allowance is given for each use. Otherwise, the unit will be given to those who wish to “sit-in.”</li>
                        <li>Observe proper decorum while inside the laboratory:
                            <ul class="list-disc list-inside ml-6">
                                <li>Do not get inside the lab unless the instructor is present.</li>
                                <li>All bags, knapsacks, and the likes must be deposited at the counter.</li>
                                <li>Follow the seating arrangement of your instructor.</li>
                                <li>At the end of class, all software programs must be closed.</li>
                                <li>Return all chairs to their proper places after using.</li>
                            </ul>
                        </li>
                        <li>Chewing gum, eating, drinking, smoking, and other forms of vandalism are prohibited inside the lab.</li>
                        <li>Anyone causing a continual disturbance will be asked to leave the lab. Acts or gestures offensive to the members of the community, including public display of physical intimacy, are not tolerated.</li>
                        <li>Persons exhibiting hostile or threatening behavior such as yelling, swearing, or disregarding requests made by lab personnel will be asked to leave the lab.</li>
                        <li>For serious offenses, the lab personnel may call the Civil Security Office (CSU) for assistance.</li>
                        <li>Any technical problem or difficulty must be addressed to the laboratory supervisor, student assistant, or instructor immediately.</li>
                    </ul>
            
                    <h4 class="text-md font-semibold text-gray-700 mt-6">DISCIPLINARY ACTION</h4>
                    <ul class="list-disc list-inside text-gray-700 space-y-2 mt-2">
                        <li><strong>First Offense</strong> – The Head or the Dean or OIC recommends to the Guidance Center for a suspension from classes for each offender.</li>
                        <li><strong>Second and Subsequent Offenses</strong> – A recommendation for a heavier sanction will be endorsed to the Guidance Center.</li>
                    </ul>
                </div>
            </section>            

            <!-- Sit-in History Section (Hidden by default) -->
            <section id="dashboard">
                <div class="bg-white p-4 rounded shadow">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-gray-300 px-4 py-2">Date</th>
                                <th class="border border-gray-300 px-4 py-2">Time In</th>
                                <th class="border border-gray-300 px-4 py-2">Time Out</th>
                                <th class="border border-gray-300 px-4 py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="sitInTableBody">
                            <!-- Data will be inserted dynamically here -->
                        </tbody>
                    </table>
                </div>
            </section>


            <!-- Reserve Session Section (Hidden by default) -->
            <section id="reserve-session" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Reserve a Session</h2>
                <div class="bg-white p-4 rounded shadow">
                    <p>Reserve a session for sit-in monitoring.</p>
                    <button class="bg-blue-500 text-white py-2 px-4 rounded">Reserve Now</button>
                </div>
            </section>
        </div>
    </div>
    <script>
        document.getElementById("uploadProfilePic").addEventListener("change", function (event) {
            const file = event.target.files[0]; // Get the selected file
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById("profilePic").src = e.target.result; // Display the uploaded image
                    saveProfilePicture(file); // Save to server or local storage
                };
                reader.readAsDataURL(file);
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            const fileInput = document.getElementById("profileImageInput");

            if (fileInput) {
                fileInput.addEventListener("change", function (event) {
                    const file = event.target.files[0];
                    const userId = new URLSearchParams(window.location.search).get("id"); // Get user ID dynamically

                    if (!userId) {
                        console.error("Error: User ID not found in URL!");
                        return;
                    }

                    if (file) {
                        uploadProfilePicture(file, userId);
                    }
                });
            } else {
                console.error("Error: File input element not found!");
            }
        });

        function saveProfilePicture(file) {
            const userId = new URLSearchParams(window.location.search).get("id");
            const formData = new FormData();
            formData.append("profileImage", file);
            formData.append("idNumber", userId);

            fetch("http://localhost:3000/upload-profile", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Profile picture updated successfully!");
                } else {
                    alert("Failed to update profile picture.");
                }
            })
            .catch(error => {
                console.error("Error uploading profile picture:", error);
                alert("Error updating profile picture.");
            });
        }

        function uploadProfilePicture(file, userId) {
            const formData = new FormData();
            formData.append("profileImage", file); // ✅ Must match Multer's expected field name
            formData.append("userId", userId);

            fetch("http://localhost:3000/upload-profile", {
                method: "POST",
                body: formData
            })
            .then(response => response.text()) // Get raw response first
            .then(text => {
                console.log("Server response:", text); // Debug
                return JSON.parse(text);
            })
            .then(data => {
                if (data.success) {
                    console.log("Upload successful:", data);
                } else {
                    console.error("Error:", data.error);
                }
            })
            .catch(error => {
                console.error("Error uploading profile picture:", error);
            });
        }


        function openChangePasswordModal() {
            document.getElementById("changePasswordModal").classList.remove("hidden");
        }

        function closeChangePasswordModal() {
            document.getElementById("changePasswordModal").classList.add("hidden");
        }

        function changePassword() {
            const currentPassword = document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmNewPassword = document.getElementById("confirmNewPassword").value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert("Please fill out all fields.");
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert("New passwords do not match.");
                return;
            }

            const userId = new URLSearchParams(window.location.search).get("id");
            console.log("User ID being sent:", userId);

            fetch("http://localhost:3000/change-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idNumber: userId,
                    currentPassword: currentPassword,
                    newPassword: newPassword
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Password updated successfully!");
                    closeChangePasswordModal();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while updating the password.");
            });
        }

        function logout() {
            fetch("/logout", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    localStorage.clear();  // Clear stored session info
                    sessionStorage.clear();
                    window.location.href = "login.html"; // Redirect to login
                })
                .catch(error => console.error("Logout error:", error));
        }
        document.addEventListener("DOMContentLoaded", function () {
            // Get user ID from the URL (e.g., student.html?id=232323)
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("id"); 

            fetch("data.json")
                .then(response => response.json())
                .then(users => {
                    console.log("Fetched Data:", users); // Debugging log

                    // Find the user with the matching ID
                    const user = users.find(u => u.idNumber === userId);

                    if (user) {
                        document.getElementById("idNumber").value = user.idNumber;
                        document.getElementById("firstname").value = user.firstName;
                        document.getElementById("middlename").value = user.middleName;
                        document.getElementById("lastname").value = user.lastName;
                        document.getElementById("email").value = user.email;
                        document.getElementById("year").value = user.year;
                        document.getElementById("course").value = user.course;

                        // Set Remaining Sessions based on course
                        const remainingSessions = ["Computer Science", "IT", "Software Engineering"].includes(user.course) ? 15 : 10;
                        document.getElementById("remainingSessions").textContent = remainingSessions;
                    } else {
                        console.error("User not found!");
                    }
                })
                .catch(error => console.error("Error loading profile data:", error));
        });

        function saveProfile() {
            const updatedData = {
                idNumber: document.getElementById("idNumber").value,
                firstName: document.getElementById("firstname").value,
                middleName: document.getElementById("middlename").value,
                lastName: document.getElementById("lastname").value,
                email: document.getElementById("email").value,
                year: document.getElementById("year").value,
                course: document.getElementById("course").value
            };

            fetch("http://localhost:3000/update-profile", {  
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to update profile");
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert("Profile updated successfully!");
                } else {
                    alert("Failed to update profile.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error updating profile.");
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const menuLinks = document.querySelectorAll(".w-64 ul li a");
    
            function hideAllSections() {
                document.querySelectorAll("section").forEach(section => {
                    section.classList.add("hidden");
                });
            }
    
            function showSavedSection() {
                let savedSection = localStorage.getItem("activeSection") || "dashboard"; // Default to Sit-in History if no selection
                let sectionToShow = document.getElementById(savedSection);
                if (sectionToShow) {
                    hideAllSections();
                    sectionToShow.classList.remove("hidden");
                }
            }
    
            menuLinks.forEach(link => {
                link.addEventListener("click", function (event) {
                    event.preventDefault();
                    let targetId = this.getAttribute("href").substring(1);
                    let targetSection = document.getElementById(targetId);
    
                    if (targetSection) {
                        hideAllSections();
                        targetSection.classList.remove("hidden");
                        localStorage.setItem("activeSection", targetId);
                    }
                });
            });
    
            showSavedSection();
        });
    </script>            
</body>
</html>
