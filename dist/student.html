<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex">

    <!-- ✅ Sidebar -->
    <div id="sidebar" class="w-64 bg-white h-screen p-5 shadow-lg flex flex-col justify-between">
        <div>
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            
            <div class="flex items-center mb-4">
                <img id="profileImageSidebar" src="/uploads/default.png" class="w-12 h-12 rounded-full border" alt="Profile">
                <div class="ml-3">
                    <p class="font-semibold" id="studentNameSidebar">Student Name</p>
                    <p class="text-sm text-gray-500" id="studentCourseSidebar">Course</p>
                </div>
            </div>

            <nav>
                <button onclick="showSection('profileSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Profile</button>
                <button onclick="showSection('announcementsSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Announcements</button>
                <button onclick="showSection('labRulesSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Lab Rules</button>
                <button onclick="showSection('sitInHistorySection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Sit-in History</button>
                <button onclick="showSection('reserveSessionSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Reserve Session</button>
            </nav>
        </div>

        <!-- ✅ Logout Button -->
        <button id="logoutBtn" class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 self-start">
            Logout
        </button>
    </div>

    <!-- ✅ Main Dashboard Content -->
    <div class="flex-1 p-6">
        <button id="toggleSidebar" class="bg-blue-500 text-white px-3 py-2 rounded mb-4">Toggle Menu</button>
        
        <!-- ✅ Welcome Message -->
        <h1 class="text-2xl font-bold mb-4" id="welcomeMessage">Welcome, User</h1>

        <!-- Profile Section -->
    <div id="profileSection" class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-3xl font-bold text-center mb-6">Profile</h2>

        <div class="flex flex-col items-center">
            <img id="profileImage" src="/uploads/default.png" class="w-32 h-32 rounded-full border mb-4" alt="Profile Picture">
            
            <form id="uploadForm" enctype="multipart/form-data" class="w-full text-center">
                <input type="file" id="imageUpload" class="block w-full text-sm text-gray-600 mb-4 hidden">
                <button type="submit" id="uploadButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition hidden">
                    Upload
                </button>
            </form>
        </div>

        <div class="mt-6">
            <p><strong>ID:</strong> <span id="userIdText"></span></p>
            <input type="text" id="userIdInput" class="w-full border p-2 rounded hidden" />

            <p class="mt-2"><strong>Full Name:</strong> <span id="fullNameText"></span></p>
            <input type="text" id="fullNameInput" class="w-full border p-2 rounded hidden" />

            <p class="mt-2"><strong>Email:</strong> <span id="emailText"></span></p>
            <input type="email" id="emailInput" class="w-full border p-2 rounded hidden" />    

            <p class="mt-2"><strong>Year:</strong> <span id="yearText"></span></p>
            <input type="text" id="yearInput" class="w-full border p-2 rounded hidden" />  
            
            <p class="mt-2"><strong>Course:</strong> <span id="courseText"></span></p>
            <input type="text" id="courseInput" class="w-full border p-2 rounded hidden" />
            
            <p><strong>Remaining Sessions:</strong> <span id="remainingSessionsText">Loading...</span></p>

            <div class="flex gap-4 mt-4">
                <button id="editProfile" class="w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition">
                    Edit Profile
                </button>

                <button id="saveProfile" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition hidden">
                    Save Changes
                </button>

                <button id="changePassword" class="w-1/2 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition hidden">
                    Change Password
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
        <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-xl font-bold mb-4">Change Password</h2>

                <label class="block mb-2">Current Password</label>
                <input type="password" id="currentPassword" class="w-full border p-2 rounded" required>

                <label class="block mt-4 mb-2">New Password</label>
                <input type="password" id="newPassword" class="w-full border p-2 rounded" required>

                <label class="block mt-4 mb-2">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="w-full border p-2 rounded" required>

                <div class="flex justify-end gap-4 mt-6">
                    <button id="closeModal" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition">
                        Cancel
                    </button>
                    <button id="updatePasswordBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Update Password
                    </button>
                </div>
            </div>
        </div>

        <!-- ✅ Announcements Section -->
        <div id="announcementsSection" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Announcements</h2>
            <p class="text-gray-600">No announcements at this time.</p>
        </div>

        <!-- ✅ Lab Rules Section -->
        <div id="labRulesSection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Lab Rules</h2>
            <p>Follow the guidelines while using lab resources.</p>
        </div>

        <!-- ✅ Sit-in History Section -->
        <div id="sitInHistorySection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Sit-in History</h2>
            <p class="text-gray-600">Your sit-in records will appear here.</p>
        </div>

        <!-- ✅ Reserve Session Section -->
        <div id="reserveSessionSection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Reserve a Session</h2>
            <p class="text-gray-600">Reserve a session for sit-in monitoring.</p>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/get-profile?id=0999") // Pass correct user ID dynamically
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error:", data.error);
                    return;
                }

                 // Populate spans
                document.getElementById("userIdText").textContent = data.idNumber;
                document.getElementById("fullNameText").textContent = data.firstName + " " + (data.middleName ? data.middleName + " " : "") + data.lastName;
                document.getElementById("emailText").textContent = data.email;
                document.getElementById("yearText").textContent = data.year;
                document.getElementById("courseText").textContent = data.course;
                document.getElementById("remainingSessionsText").textContent = data.remainingSessions;

                // Populate hidden input fields
                document.getElementById("userIdInput").value = data.idNumber;
                document.getElementById("fullNameInput").value = document.getElementById("fullNameText").textContent;
                document.getElementById("emailInput").value = data.email;
                document.getElementById("yearInput").value = data.year;
                document.getElementById("courseInput").value = data.course;
            })
            .catch(error => console.error("Error fetching profile:", error));
    });

    document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("id");

    if (!userId) {
        alert("User not found!");
        return;
    }

    try {
        // Fetch user data
        const response = await fetch(`/get-profile?id=${userId}`);
        const user = await response.json();

        if (user.error) {
            alert(user.error);
            return;
        }

        // ✅ Update Profile Info
        document.getElementById("profileImage").src = user.profileImage || "/uploads/default.png";
        document.getElementById("userIdText").textContent = user.idNumber;
        document.getElementById("fullNameText").textContent = `${user.firstName} ${user.middleName} ${user.lastName}`;
        document.getElementById("emailText").textContent = user.email;
        document.getElementById("studentCourseSidebar").textContent = user.course; // Update sidebar course text

        // ✅ Determine Remaining Sessions
        let remainingSessions = user.remainingSessions; // Default from DB
        if (remainingSessions === undefined || remainingSessions === null) {
            const computerCourses = ["computer", "it", "cs", "informatics", "software", "programming"];
            remainingSessions = computerCourses.some(keyword => user.course.toLowerCase().includes(keyword)) ? 15 : 10;
        }

        // ✅ Display Remaining Sessions
        document.getElementById("remainingSessionsText").textContent = remainingSessions;

    } catch (error) {
        console.error("Error fetching profile:", error);
        alert("Failed to load profile data.");
    }
});

document.getElementById("updatePasswordBtn").addEventListener("click", async function (e) {
    e.preventDefault(); // Prevent default form submission

    const currentPassword = document.getElementById("currentPassword").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();
    const confirmPassword = document.getElementById("confirmPassword").value.trim();

    if (!currentPassword || !newPassword || !confirmPassword) {
        alert("Please fill in all fields.");
        return;
    }

    if (newPassword !== confirmPassword) {
        alert("New password and confirm password do not match.");
        return;
    }

    try {
        const response = await fetch("/update-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentPassword, newPassword, confirmPassword }) // Send all expected fields
        });

        const data = await response.json();

        if (response.ok) {
            alert("Password updated successfully!");
            document.getElementById("passwordModal").classList.add("hidden"); // Close modal
        } else {
            alert("Error: " + (data.message || "Failed to update password."));
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    }

    // Debugging: Check form data
    const formData = new FormData(document.getElementById('changePasswordForm'));
    for (let [key, value] of formData.entries()) {
        console.log(key, value); // Debugging output
    }
});


        // ✅ Sidebar Toggle
        document.getElementById("toggleSidebar").addEventListener("click", () => {
            document.getElementById("sidebar").classList.toggle("-translate-x-64");
        });

        // ✅ Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            window.location.href = "/login.html";
        });

        function showSection(sectionId) {
            document.querySelectorAll(".bg-white.p-6.rounded-lg.shadow-md").forEach(section => {
                section.classList.add("hidden");
            });
            document.getElementById(sectionId).classList.remove("hidden");
        }

        // ✅ Profile Image Upload
            document.addEventListener("DOMContentLoaded", async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get("id");

                if (!userId) {
                    alert("User not found!");
                    return;
                }

                // Fetch user data
                const response = await fetch(`/get-profile?id=${userId}`);
                const user = await response.json();

        if (user.error) {
            alert(user.error);
        } else {
            // Populate user data
            document.getElementById("profileImage").src = user.profileImage || "/uploads/default.png";
            document.getElementById("userIdText").textContent = user.idNumber;
            document.getElementById("fullNameText").textContent = `${user.firstName} ${user.middleName} ${user.lastName}`;
            document.getElementById("emailText").textContent = user.email;
            document.getElementById("remainingSessions").textContent = user.remainingSessions;

                // Set values for input fields
            document.getElementById("userIdInput").value = user.idNumber;
            document.getElementById("fullNameInput").value = `${user.firstName} ${user.middleName} ${user.lastName}`;
            document.getElementById("emailInput").value = user.email;
        }
    });

        // Edit Profile Button
        document.getElementById("editProfile").addEventListener("click", function () {
            // Hide text spans
            document.getElementById("fullNameText").classList.add("hidden");
            document.getElementById("emailText").classList.add("hidden");
            document.getElementById("yearText").classList.add("hidden");
            document.getElementById("courseText").classList.add("hidden");

            // Show input fields
            document.getElementById("fullNameInput").classList.remove("hidden");
            document.getElementById("emailInput").classList.remove("hidden");
            document.getElementById("yearInput").classList.remove("hidden");
            document.getElementById("courseInput").classList.remove("hidden");

            // Hide "Edit Profile" button, show "Save" and "Change Password"
            document.getElementById("editProfile").classList.add("hidden");
            document.getElementById("saveProfile").classList.remove("hidden");
            document.getElementById("changePassword").classList.remove("hidden");
        });


    // Save Profile Changes
    document.getElementById("saveProfile").addEventListener("click", function () {
    const updatedProfile = {
        idNumber: document.getElementById("userIdInput").value,
        fullName: document.getElementById("fullNameInput").value,
        email: document.getElementById("emailInput").value,
        year: document.getElementById("yearInput").value,
        course: document.getElementById("courseInput").value
    };

    fetch("/update-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", // Important to send cookies
        body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
    })

    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Profile updated successfully!");

            // Update spans with new values
            document.getElementById("fullNameText").textContent = updatedProfile.fullName;
            document.getElementById("emailText").textContent = updatedProfile.email;
            document.getElementById("yearText").textContent = updatedProfile.year;
            document.getElementById("courseText").textContent = updatedProfile.course;

            // Hide input fields and show text spans
            document.getElementById("fullNameInput").classList.add("hidden");
            document.getElementById("emailInput").classList.add("hidden");
            document.getElementById("yearInput").classList.add("hidden");
            document.getElementById("courseInput").classList.add("hidden");

            document.getElementById("fullNameText").classList.remove("hidden");
            document.getElementById("emailText").classList.remove("hidden");
            document.getElementById("yearText").classList.remove("hidden");
            document.getElementById("courseText").classList.remove("hidden");

            // Show "Edit Profile" button again
            document.getElementById("editProfile").classList.remove("hidden");
            document.getElementById("saveProfile").classList.add("hidden");
            document.getElementById("changePassword").classList.add("hidden");
        } else {
            alert("Error updating profile.");
        }
    })
    .catch(error => console.error("Error updating profile:", error));
});


        // Open Change Password Modal
        document.getElementById("changePassword").addEventListener("click", () => {
            document.getElementById("passwordModal").classList.remove("hidden");
        });

        // Close Modal
        document.getElementById("closeModal").addEventListener("click", () => {
            document.getElementById("passwordModal").classList.add("hidden");
        });

        // Submit Password Change
        document.getElementById("submitPasswordChange").addEventListener("click", async () => {
            const currentPassword = document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            if (newPassword !== confirmPassword) {
                alert("New passwords do not match!");
                return;
            }

            const response = await fetch("/change-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const result = await response.json();
            if (result.success) {
                alert("Password changed successfully!");
                document.getElementById("passwordModal").classList.add("hidden");
            } else {
                alert(result.error);
            }
        });
    </script>    
</body>
</html>
