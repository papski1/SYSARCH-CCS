<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex">

    <!-- ✅ Sidebar -->
    <div id="sidebar" class="w-64 bg-white h-screen p-5 shadow-lg flex flex-col justify-between">
        <div>
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            
            <div class="flex items-center mb-4">
                <img id="profileImageSidebar" src="/uploads/default.png" class="w-12 h-12 rounded-full border" alt="Profile">
                <div class="ml-3">
                    <p class="font-semibold" id="studentNameSidebar">Student Name</p>
                    <p class="text-sm text-gray-500" id="studentCourseSidebar">Course</p>
                </div>
            </div>

            <nav>
                <button onclick="showSection('profileSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Profile</button>
                <button onclick="showSection('announcementsSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Announcements</button>
                <button onclick="showSection('labRulesSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Lab Rules</button>
                <button onclick="showSection('sitInHistorySection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Sit-in History</button>
                <button onclick="showSection('reserveSessionSection')" class="block py-2 text-gray-700 hover:bg-gray-200 px-3 rounded text-left w-full">Reserve Session</button>
            </nav>
        </div>

        <!-- ✅ Logout Button -->
        <button id="logoutBtn" class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 self-start">
            Logout
        </button>
    </div>

    <!-- ✅ Main Dashboard Content -->
    <div class="flex-1 p-6">
        <button id="toggleSidebar" class="bg-blue-500 text-white px-3 py-2 rounded mb-4">Toggle Menu</button>
        
        <!-- ✅ Welcome Message -->
        <h1 class="text-2xl font-bold mb-4" id="welcomeMessage">Welcome, User</h1>

        <!-- Updated Profile Section -->
        <!-- Profile Section -->
    <div id="profileSection" class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-3xl font-bold text-center mb-6">Profile</h2>

        <div class="flex flex-col items-center">
            <img id="profileImage" src="/uploads/default.png" class="w-32 h-32 rounded-full border mb-4" alt="Profile Picture">
            
            <form id="uploadForm" enctype="multipart/form-data" class="w-full text-center">
                <input type="file" id="imageUpload" class="block w-full text-sm text-gray-600 mb-4 hidden">
                <button type="submit" id="uploadButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition hidden">
                    Upload
                </button>
            </form>
        </div>

        <div class="mt-6">
            <p><strong>ID:</strong> <span id="userIdText"></span></p>
            <input type="text" id="userIdInput" class="w-full border p-2 rounded hidden" />

            <p class="mt-2"><strong>Full Name:</strong> <span id="fullNameText"></span></p>
            <input type="text" id="fullNameInput" class="w-full border p-2 rounded hidden" />

            <p class="mt-2"><strong>Email:</strong> <span id="emailText"></span></p>
            <input type="email" id="emailInput" class="w-full border p-2 rounded hidden" />

            <p class="mt-2"><strong>Remaining Sessions:</strong> <span id="remainingSessions" class="font-bold text-lg text-blue-600"></span></p>

            <div class="flex gap-4 mt-4">
                <button id="editProfile" class="w-1/2 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition">
                    Edit Profile
                </button>

                <button id="saveProfile" class="w-1/2 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition hidden">
                    Save Changes
                </button>

                <button id="changePassword" class="w-1/2 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition hidden">
                    Change Password
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">Change Password</h2>

            <label class="block mb-2">Current Password</label>
            <input type="password" id="currentPassword" class="w-full border p-2 rounded">

            <label class="block mt-4 mb-2">New Password</label>
            <input type="password" id="newPassword" class="w-full border p-2 rounded">

            <label class="block mt-4 mb-2">Confirm New Password</label>
            <input type="password" id="confirmNewPassword" class="w-full border p-2 rounded">

            <div class="flex justify-end gap-4 mt-6">
                <button id="closeModal" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition">
                    Cancel
                </button>
                <button id="submitPasswordChange" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                    Update Password
                </button>
            </div>
        </div>
    </div>

        <!-- ✅ Announcements Section -->
        <div id="announcementsSection" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Announcements</h2>
            <p class="text-gray-600">No announcements at this time.</p>
        </div>

        <!-- ✅ Lab Rules Section -->
        <div id="labRulesSection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Lab Rules</h2>
            <p>Follow the guidelines while using lab resources.</p>
        </div>

        <!-- ✅ Sit-in History Section -->
        <div id="sitInHistorySection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Sit-in History</h2>
            <p class="text-gray-600">Your sit-in records will appear here.</p>
        </div>

        <!-- ✅ Reserve Session Section -->
        <div id="reserveSessionSection" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold">Reserve a Session</h2>
            <p class="text-gray-600">Reserve a session for sit-in monitoring.</p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("id");
    
            if (!userId) {
                alert("User not found!");
                return;
            }
    
            // ✅ Fetch user data
            const response = await fetch(`/get-profile?id=${userId}`);
            const user = await response.json();
    
            if (user.error) {
                alert(user.error);
            } else {
                // ✅ Update Sidebar Info
                document.getElementById("profileImageSidebar").src = user.profileImage || "/uploads/default.png";
                document.getElementById("studentNameSidebar").textContent = `${user.firstName} ${user.lastName}`;
                document.getElementById("studentCourseSidebar").textContent = user.course;
                
                // ✅ Set Welcome Message
                document.getElementById("welcomeMessage").textContent = `Welcome, ${user.firstName}`;

                // ✅ Update Profile Section
                document.getElementById("profileImage").src = user.profileImage || "/uploads/default.png";
                document.getElementById("userInfo").innerHTML = `
                    <p><strong>ID:</strong> ${user.idNumber}</p>
                    <p><strong>Name:</strong> ${user.firstName} ${user.middleName} ${user.lastName}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Year:</strong> ${user.year}</p>
                    <p><strong>Course:</strong> ${user.course}</p>
                `;
            }
        });

        // ✅ Sidebar Toggle
        document.getElementById("toggleSidebar").addEventListener("click", () => {
            document.getElementById("sidebar").classList.toggle("-translate-x-64");
        });

        // ✅ Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            window.location.href = "/login.html";
        });

        function showSection(sectionId) {
            document.querySelectorAll(".bg-white.p-6.rounded-lg.shadow-md").forEach(section => {
                section.classList.add("hidden");
            });
            document.getElementById(sectionId).classList.remove("hidden");
        }

        // ✅ Profile Image Upload
        document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("id");

    if (!userId) {
        alert("User not found!");
        return;
    }

    // Fetch user data
    const response = await fetch(`/get-profile?id=${userId}`);
    const user = await response.json();

    if (user.error) {
        alert(user.error);
    } else {
        // Populate user data
        document.getElementById("profileImage").src = user.profileImage || "/uploads/default.png";
        document.getElementById("userIdText").textContent = user.idNumber;
        document.getElementById("fullNameText").textContent = `${user.firstName} ${user.middleName} ${user.lastName}`;
        document.getElementById("emailText").textContent = user.email;
        document.getElementById("remainingSessions").textContent = user.remainingSessions;

        // Set values for input fields
        document.getElementById("userIdInput").value = user.idNumber;
        document.getElementById("fullNameInput").value = `${user.firstName} ${user.middleName} ${user.lastName}`;
        document.getElementById("emailInput").value = user.email;
    }
});

// Edit Profile Button
document.getElementById("editProfile").addEventListener("click", () => {
    document.getElementById("userIdText").classList.add("hidden");
    document.getElementById("fullNameText").classList.add("hidden");
    document.getElementById("emailText").classList.add("hidden");

    document.getElementById("userIdInput").classList.remove("hidden");
    document.getElementById("fullNameInput").classList.remove("hidden");
    document.getElementById("emailInput").classList.remove("hidden");

    document.getElementById("saveProfile").classList.remove("hidden");
    document.getElementById("changePassword").classList.remove("hidden");
    document.getElementById("editProfile").classList.add("hidden");
});

// Save Profile Changes
    document.getElementById("saveProfile").addEventListener("click", async () => {
        const updatedUser = {
            idNumber: document.getElementById("userIdInput").value,
            fullName: document.getElementById("fullNameInput").value,
            email: document.getElementById("emailInput").value
        };

        const response = await fetch("/update-profile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedUser)
        });

        const result = await response.json();
        if (result.success) {
            alert("Profile updated successfully!");

            document.getElementById("userIdText").textContent = updatedUser.idNumber;
            document.getElementById("fullNameText").textContent = updatedUser.fullName;
            document.getElementById("emailText").textContent = updatedUser.email;

            document.getElementById("editProfile").classList.remove("hidden");
            document.getElementById("saveProfile").classList.add("hidden");
            document.getElementById("changePassword").classList.add("hidden");
        } else {
            alert("Error updating profile.");
        }
    });

    // Open Change Password Modal
    document.getElementById("changePassword").addEventListener("click", () => {
        document.getElementById("passwordModal").classList.remove("hidden");
    });

    // Close Modal
    document.getElementById("closeModal").addEventListener("click", () => {
        document.getElementById("passwordModal").classList.add("hidden");
    });

    // Submit Password Change
    document.getElementById("submitPasswordChange").addEventListener("click", async () => {
        const currentPassword = document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmNewPassword = document.getElementById("confirmNewPassword").value;

        if (newPassword !== confirmNewPassword) {
            alert("New passwords do not match!");
            return;
        }

        const response = await fetch("/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentPassword, newPassword })
        });

        const result = await response.json();
        if (result.success) {
            alert("Password changed successfully!");
            document.getElementById("passwordModal").classList.add("hidden");
        } else {
            alert(result.error);
        }
    });
    </script>    
</body>
</html>
